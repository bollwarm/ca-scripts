#!/bin/sh

DIR=$(pwd)
CONFIG_DIR="$DIR/config"
source $CONFIG_DIR/globals

function is_integer()
{
	if [[ $1 =~ ^-?[0-9]+$ ]]
	then
		return 0
	fi

	return 1
}

if [ "$#" -ne 3 ]
then
	echo "Usage: sign_key [crs] [cert name] [days | years]"
	exit
fi

CSR=$1
CERT=$2
DAYS=$3

if [[ ${DAYS%%*y} == $DAYS ]]
then
	if is_integer $DAYS
	then
		END_DAYS=$(( $(date '+%s') + $(( $DAYS * 86400 )) ))
	else
		echo "Please use an interger for days."
		exit -1
	fi
else
	YEARS=${DAYS%*y}
	if is_integer $YEARS
	then
		echo "it is in years. $YEARS"
	else
		echo "Please use an interger for years"
		exit -1
	fi
fi

END_DATE=$(date -jnu -f '%s' $END_DAYS '+%+')

exit

if okay_to_create_file $CERT "\033[97mIntermediate CA exists \033[93m($CERT)\033[97m. Do you want to create a new one?" "n"
then
	echo "\033[97mThe certificate \033[90m($CERT)\033[97m will be valid for \033[93m$DAYS days\033[97m (ends on: $END_DATE)\033[39m"

	openssl ca -config $ROOT_CA_OPENSSL_CONFIG -extensions v3_intermediate_ca \
		   -days $DAYS -notext -md sha256 \
		   -in $CSR \
		   -out $CERT

	chmod 444 $CERT
fi

