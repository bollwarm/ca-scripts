#!/bin/sh

if [ "$#" -ne 4 ]
then
	echo "Usage: $0 [cert type] [certificate] [key] [config]"
	exit -1
fi

DIR=$(pwd)
CONFIG_DIR="$DIR/config"
source $CONFIG_DIR/globals

CERT_TYPE=$1
CERTIFICATE_FILE=$2
KEY_FILE=$3
CONFIG_FILE=$4

if [[ -e $CERTIFICATE_FILE ]]
then
        echo "\033[97m$CERT_TYPE certificate \033[93m($CERTIFICATE_FILE)\033[97m already exists. Do you want to create a new one? [y/N] \c"
	read ans
	echo "\033[39m\c"

	if [ -n "$ans" ] && [ $(echo "$ans" | awk '{print toupper($0)}') == "Y" ]
	then
		chmod u+w $CERTIFICATE_FILE
		create_cert="yes"
	 fi
else
	create_cert="yes"
fi

if [ ! -z "$create_cert" ]
then
	D1=$(date '+%s')
	D2=$(date -jnu -f '%s' -v+$ROOT_CA_VALIDITY "$D1" '+%s')
	END_DATE=$(date -jnu -f '%s' $D2 '+%+')

	DAYS=$(get_date_difference_in_days "$D1" "$D2")

	echo "\033[90m$CERT_TYPE will be valid for \033[93m$DAYS days\033[90m (ends on: $END_DATE)\033[39m"

	openssl req -config $CONFIG_FILE -key $KEY_FILE -new -x509 -days $DAYS -sha256 -extensions v3_ca -out $CERTIFICATE_FILE

	chmod 444 $CERTIFICATE_FILE
fi

