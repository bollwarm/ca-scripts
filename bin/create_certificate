#!/bin/sh

DIR=$(pwd)
CONFIG_DIR="$DIR/config"
source $CONFIG_DIR/globals

case "$#" in
    5)
        CERT_NAME="Root CA"
        CERT_TYPE="r"
        ;;
    6)
        CERT_NAME="Intermediate CA"
        CSR=$6
        CERT_TYPE="i"
        ;;
    *)
        echo "Usage: ${0##/} [certificate] [key] [config] [days | years] [extension] | [csr]"

        exit -1
        ;;
esac

CERTIFICATE=$1
KEY=$2
CONFIG=$3
VALIDITY=$4
EXTENSION=$5

if [[ -e $CERTIFICATE ]]
then
    echo "\033[97m$CERT_NAME certificate \033[93m($CERTIFICATE)\033[97m already exists. Do you want to create a new one? [y/N] \c"
    read ans
    echo "\033[39m\c"

    if [ -n "$ans" ] && [ $(echo "$ans" | awk '{print toupper($0)}') == "Y" ]
    then
        chmod u+w $CERTIFICATE
    else
        exit 0
    fi
fi

D1=$(date '+%s')
D2=$(date -jnu -f '%s' -v+$VALIDITY "$D1" '+%s')
END_DATE=$(date -jnu -f '%s' $D2 '+%+')

DAYS=$(get_date_difference_in_days "$D1" "$D2")

echo "\033[90m$CERT_NAME will be valid for \033[93m$DAYS days\033[90m (ends on: $END_DATE)\033[39m"

case $CERT_TYPE in
    r)
        openssl req -config $CONFIG -key $KEY -new -x509 -days $DAYS -sha256 -extensions $EXTENSION -out $CERTIFICATE
        ;;
    i)
        openssl ca -config $CONFIG -extensions $EXTENSION -days $DAYS -notext -md sha256 -in $CSR -out $CERTIFICATE
        ;;
esac

chmod 444 $CERTIFICATE
