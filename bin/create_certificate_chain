#!/bin/sh

DIR=$(pwd)
CONFIG_DIR="$DIR/config"
source $CONFIG_DIR/globals

function missing_certificate()
{
	echo "\033[93m$1\033[97m was not found! Missing certificate must be present before creating the chain will succeed.\033[39m"
}

[ -e $ROOT_CA_CERT ]                 && D1=$(stat -f '%m' $ROOT_CA_CERT)
[ -e $INTERMEDIATE_CA_CERT ]         && D2=$(stat -f '%m' $INTERMEDIATE_CA_CERT)
[ -e $INTERMEDIATE_CA_CACHAIN_CERT ] && D3=$(stat -f '%m' $INTERMEDIATE_CA_CACHAIN_CERT)

if [ -z "$D1" ]
then
	missing_certificate "$ROOT_CA_CERT"

	exit 1
fi

if [ -z "$D2" ]
then
	missing_certificate "$INTERMEDIATE_CA_CERT"

	exit 1
fi
	
if [[ "$D3" -lt "$D1" ]] || [[ "$D3" -lt "$D2" ]]
then
	if [[ -n "$D3" ]]
	then
		echo "\033[97mOne of the certificates has a newer date then the intermediate chained certificate. Therefore the chain is recreated.\033[39m"
	fi

	[ -e "$INTERMEDIATE_CA_CACHAIN_CERT" ] && chmod u+w $INTERMEDIATE_CA_CACHAIN_CERT

	cat $INTERMEDIAET_CA_CERT $ROOT_CA_CERT > $INTERMEDIATE_CA_CACHAIN_CERT


	chmod 444 $INTERMEDIATE_CA_CACHAIN_CERT
fi
